<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
</head>
<body>

<div id="app">
  <h3>Data Binding</h3>
  <p>{{message}}</p>
  <input type="text" v-model="message">
  <h3>Default Directive(v-onclick)</h3>
  <button type="button" v-onclick="reverseMessage">
    {{btnName}}
  </button>
  <h3>Components</h3>
  <hello-component></hello-component>
  <ul>
    <list></list>
    <list></list>
    <list></list>
    <list></list>
  </ul>
  <h3>Directives</h3>
  <div helloworld></div>
</div>

<script src="component.js"></script>
<script src="directive.js"></script>
<script src="observer.js"></script>
<script src="template.js"></script>

<script>
function VanillaJsVue(options){
  let template = null;
  const watcher = {};

  const vModel = {
    name: 'v-model',
    bind: (elem, variableName) => {
      elem.value = options.data[variableName];
      elem.oninput = ((variableName => () => {
        options.data[variableName] = elem.value;
      })(variableName));
    }
  };

  const vOnClick = {
    name: 'v-onclick',
    bind: (elem, callbackName) => {
      elem.onclick = ((callbackName => event => {
        options.methods[callbackName].call(options.data, event);
      })(callbackName));
    }
  };

  const platformDirectives = [
    vOnClick,
    vModel
  ];

  const initTemplate = () => {
    template = useTemplate(options.el);
    template.bindData(options.data);
  };

  const runWatcher = (keyName, newVal) => {
    let callbacks = [];
    if(watcher.hasOwnProperty(keyName)){
      callbacks = watcher[keyName];
      callbacks.forEach(callback => {
        callback.call(options.data, newVal);
      });
    }
  };

  const initWatch = () => {
    let keyName;

    for(keyName in options.watch){
      watcher[keyName] = watcher[keyName] || [];
      watcher[keyName].push(options.watch[keyName]);
    }

    for(keyName in options.data){
      (((dataObj, keyName, template) => {
        Observer(
          dataObj,
          keyName,
          (newValue) => {
            template.bindData({
              [keyName]: newValue
            });
            runWatcher(keyName, newValue);
          }
        );
      })(options.data, keyName, template));
    }
  };

  const initDirective = () => {
    let directiveName = '';

    platformDirectives.forEach(directive => {
      Directive.define(directive);
    });

    for(directiveName in options.directives){
      Directive.define({
        name: directiveName,
        bind: ((bindCallback => (elem, args) => {
          bindCallback(elem, ...args);
        })(options.directives[directiveName].bind))
      });
    }

    Directive.render(options.el);
  };

  const initComponents = () => {
    let componentName = '';
    for(componentName in options.components){
      Component.define({
        name: componentName,
        template: options.components[componentName].template
      });
    }

    Component.render(options.el);
  };

  const init = () => {
    initTemplate();
    initWatch();
    initDirective();
    initComponents();
  };

  init(options);
}
</script>
<script>
VanillaJsVue({
  el: '#app',
  data: {
    message: 'Hello World',
    btnName: 'Reverse Message'
  },
  watch: {
    message: val => {
      console.log(val);
    }
  },
  methods: {
    reverseMessage () {
      this.message = this.message.split('').reverse().join('');
    }
  },
  directives: {
    'helloworld': {
      bind: el => {
        el.innerHTML = 'Hello World';
      }
    }
  },
  components: {
    'hello-component': {
      template: '<p>Hello Component!!</p>'
    },
    'list': {
      template: '<li>list</li>'
    }
  }
});
</script>
</body>
</html>
